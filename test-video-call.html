<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Video Call</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #4F46E5;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
        }
        .test-button:hover {
            background: #4338CA;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Test Video Call Functionality</h1>
        
        <div class="status info">
            <strong>Instructions:</strong> Click the buttons below to test video call functionality. Check the console and log below for debugging information.
        </div>
        
        <button class="test-button" id="testVideoCall">Test Video Call</button>
        <button class="test-button" id="testVoiceCall">Test Voice Call</button>
        <button class="test-button" id="testWebSocket">Test WebSocket Connection</button>
        <button class="test-button" id="testMediaAccess">Test Media Access</button>
        
        <div id="status"></div>
        
        <h3>Debug Log:</h3>
        <div class="log" id="debugLog"></div>
    </div>

    <script src="config.js"></script>
    <script>
        class VideoCallTester {
            constructor() {
                this.debugLog = document.getElementById('debugLog');
                this.status = document.getElementById('status');
                this.websocket = null;
                this.localStream = null;
                this.peerConnection = null;
                
                this.setupEventListeners();
                this.log('Video Call Tester initialized');
            }
            
            setupEventListeners() {
                document.getElementById('testVideoCall').addEventListener('click', () => this.testVideoCall());
                document.getElementById('testVoiceCall').addEventListener('click', () => this.testVoiceCall());
                document.getElementById('testWebSocket').addEventListener('click', () => this.testWebSocket());
                document.getElementById('testMediaAccess').addEventListener('click', () => this.testMediaAccess());
            }
            
            log(message) {
                const timestamp = new Date().toLocaleTimeString();
                this.debugLog.innerHTML += `[${timestamp}] ${message}\n`;
                this.debugLog.scrollTop = this.debugLog.scrollHeight;
                console.log(message);
            }
            
            showStatus(message, type = 'info') {
                this.status.innerHTML = `<div class="status ${type}">${message}</div>`;
            }
            
            async testVideoCall() {
                this.log('🎥 Testing video call...');
                this.showStatus('Testing video call...', 'info');
                
                try {
                    // Test media access
                    this.log('Requesting media access...');
                    this.localStream = await navigator.mediaDevices.getUserMedia({
                        video: true,
                        audio: true
                    });
                    this.log('✅ Media access granted');
                    
                    // Test WebSocket connection
                    await this.testWebSocket();
                    
                    // Test peer connection
                    this.log('Creating peer connection...');
                    const iceServers = CURRENT_CONFIG.STUN_SERVERS.map(url => ({ urls: url }));
                    this.peerConnection = new RTCPeerConnection({ iceServers });
                    this.log('✅ Peer connection created');
                    
                    // Add tracks
                    this.localStream.getTracks().forEach(track => {
                        this.peerConnection.addTrack(track, this.localStream);
                        this.log(`Added ${track.kind} track`);
                    });
                    
                    // Test offer creation
                    this.log('Creating offer...');
                    const offer = await this.peerConnection.createOffer();
                    await this.peerConnection.setLocalDescription(offer);
                    this.log('✅ Offer created and set');
                    
                    this.showStatus('Video call test completed successfully!', 'success');
                    this.log('✅ Video call test completed successfully');
                    
                } catch (error) {
                    this.log(`❌ Video call test failed: ${error.message}`);
                    this.showStatus(`Video call test failed: ${error.message}`, 'error');
                }
            }
            
            async testVoiceCall() {
                this.log('🔊 Testing voice call...');
                this.showStatus('Testing voice call...', 'info');
                
                try {
                    // Test audio-only media access
                    this.log('Requesting audio access...');
                    this.localStream = await navigator.mediaDevices.getUserMedia({
                        video: false,
                        audio: true
                    });
                    this.log('✅ Audio access granted');
                    
                    this.showStatus('Voice call test completed successfully!', 'success');
                    this.log('✅ Voice call test completed successfully');
                    
                } catch (error) {
                    this.log(`❌ Voice call test failed: ${error.message}`);
                    this.showStatus(`Voice call test failed: ${error.message}`, 'error');
                }
            }
            
            async testWebSocket() {
                this.log('🔌 Testing WebSocket connection...');
                this.showStatus('Testing WebSocket...', 'info');
                
                return new Promise((resolve, reject) => {
                    const wsUrl = CURRENT_CONFIG.WS_URL;
                    this.log(`Connecting to: ${wsUrl}`);
                    
                    this.websocket = new WebSocket(wsUrl);
                    
                    this.websocket.onopen = () => {
                        this.log('✅ WebSocket connected');
                        this.showStatus('WebSocket connection successful!', 'success');
                        resolve();
                    };
                    
                    this.websocket.onerror = (error) => {
                        this.log(`❌ WebSocket error: ${error}`);
                        this.showStatus('WebSocket connection failed!', 'error');
                        reject(error);
                    };
                    
                    this.websocket.onclose = () => {
                        this.log('WebSocket closed');
                    };
                    
                    // Timeout after 5 seconds
                    setTimeout(() => {
                        if (this.websocket.readyState !== WebSocket.OPEN) {
                            this.log('❌ WebSocket connection timeout');
                            this.showStatus('WebSocket connection timeout!', 'error');
                            reject(new Error('Connection timeout'));
                        }
                    }, 5000);
                });
            }
            
            async testMediaAccess() {
                this.log('📹 Testing media access...');
                this.showStatus('Testing media access...', 'info');
                
                try {
                    // Test video and audio
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: true,
                        audio: true
                    });
                    
                    this.log(`✅ Media access granted`);
                    this.log(`Video tracks: ${stream.getVideoTracks().length}`);
                    this.log(`Audio tracks: ${stream.getAudioTracks().length}`);
                    
                    // Stop tracks
                    stream.getTracks().forEach(track => track.stop());
                    
                    this.showStatus('Media access test successful!', 'success');
                    this.log('✅ Media access test completed');
                    
                } catch (error) {
                    this.log(`❌ Media access test failed: ${error.message}`);
                    this.showStatus(`Media access failed: ${error.message}`, 'error');
                }
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new VideoCallTester();
        });
    </script>
</body>
</html>
